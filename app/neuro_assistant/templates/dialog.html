{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>–î–∏–∞–ª–æ–≥ —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º</title>
        <link
            rel="stylesheet"
            href="{% static '/neuro_assistant/css/styles.css' %}"
        />
        <script src="//unpkg.com/alpinejs" defer></script>
        <script src="https://unpkg.com/marked@0.3.6"></script>
    </head>
    <body>
        {% include 'includes/add_to_cart_popup.html' %}
        <div class="chat-container" x-data="chat">
            <div class="chat-box">
                <div class="chat-messages">
                    <template x-for="msg in messages" :key="msg.id">
                        <div
                            x-markdown="msg.text"
                            :class="msg.role == 'assistant' ? 'chat-message assistant' : 'chat-message user'"
                        ></div>
                    </template>
                    <div
                        x-show="isConsultantTyping"
                        class="chat-message assistant"
                    >
                        –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–∏—à–µ—Ç...
                    </div>
                </div>

                <div class="cart-message" id="added_to_cart_message">–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É</div>

            </div>
            
            <div class="input-container">
                <input
                    type="text"
                    class="chat-input"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    x-model="newMessageText"
                    @keydown.enter="sendMessage"
                />
                <div @click="sendMessage" class="send-button">
                    <img
                        src="{% static '/neuro_assistant/icons/send.svg' %}"
                        width="30"
                        height="30"
                        alt="image format png"
                    />
                </div>
            </div>
        </div>
        <script>

            var renderer = new marked.Renderer();
            renderer.link = function (href, title, text) {
                // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ —Å—Å—ã–ª–∫–∏ –∏–∑ markdown –≤ html
                var link = marked.Renderer.prototype.link.call(
                    this,
                    href,
                    title,
                    text
                );
                // –ø–æ–ª—É—á–∞–∞–µ–º id —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å—Å—ã–ª–∫–∏ http://BASE_URL/products/9/
                productID = link.match(/\/products\/(\d+)/)[1];
                // –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É –∏ –∞—Ç—Ä–∏–±—É—Ç target –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                return link.replace("<a", `<a class='add-to-cart' onclick='addToCart(${productID}, "${text}")'>üõí  </a><a target='_blank' `);
            };

            marked.setOptions({
                renderer: renderer,
            });
            document.addEventListener("alpine:initializing", () => {
                Alpine.directive(
                    "markdown",
                    (el, { expression }, { effect, evaluateLater }) => {
                        let getHTML = evaluateLater(expression);

                        effect(() => {
                            getHTML((input) => {
                                el.innerHTML = marked(input, {
                                    sanitize: true,
                                });
                            });
                        });
                    }
                );
            });
            
            document.addEventListener("alpine:init", () => {
                Alpine.data("chat", () => ({
                    messages: [],
                    newMessageText: "",
                    isConsultantTyping: false,
                    // –ó–¥–µ—Å—å –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                    url: "{{ consultant_api_url }}",
                    init(){
                        const savedMessages = localStorage.getItem('chatMessages');
                        if (savedMessages) {
                            this.messages = JSON.parse(savedMessages);
                        }
                    },
                    sendMessage() {
                        // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
                        if (this.newMessageText == '/reset') {
                            this.newMessageText = '';
                            this.messages = [];
                            localStorage.removeItem('chatMessages');
                            return
                        }
                        
                        // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É
                        let payload = {
                            text: this.newMessageText,
                            messages: this.messages.map(message => ({
                                content: message.text,
                                role: message.role
                            }))                            
                        };
                        this.messages.push({
                            text: this.newMessageText,
                            role: "user",
                            id: Date.now(),
                        });
                        
                        this.isConsultantTyping = true;

                        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É
                        fetch(this.url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(payload),
                            mode: "cors", 
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                console.log(data);
                                this.messages.push({
                                    text: data.answer,
                                    role: "assistant",
                                    id: Date.now(),
                                });
                                this.isConsultantTyping = false;
                                // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ localStorage
                                localStorage.setItem('chatMessages', JSON.stringify(this.messages));
                            });
                        this.newMessageText = "";
                    },

                }));
            });
        </script>
    </body>
</html>
